cd---
phase: 10-video-location-ux
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/components/MarkerPopup.jsx
  - src/pages/MapPage.jsx
  - src/services/locationService.js
autonomous: true
---

<objective>
Display linked videos in map marker popups for visited locations.

Purpose: Users can see and click through to YouTube videos directly from the map popup, connecting locations to video content.
Output: MarkerPopup shows video links for locations that have linked videos.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/10-video-location-ux/10-01-SUMMARY.md

@src/components/MarkerPopup.jsx
@src/pages/MapPage.jsx
@src/services/locationService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update fetchLocations to include video data</name>
  <files>src/services/locationService.js</files>
  <action>
Modify fetchLocations to optionally include linked videos:

1. Update the Supabase query to include the location_videos junction with video data:
```javascript
.select(`
  *,
  category:categories(*),
  videos:location_videos(
    display_order,
    video:videos(id, youtube_id, title, thumbnail_url)
  )
`)
```

2. After fetching, flatten the videos array for each location:
   - Sort by display_order
   - Map to just the video object (remove the junction wrapper)
   - Set to empty array if null/undefined

This way MapPage gets locations with their videos in one query, no need for separate fetchLocationWithVideos call per popup.
  </action>
  <verify>fetchLocations returns locations with videos array populated for locations that have linked videos</verify>
  <done>fetchLocations includes linked videos in single query</done>
</task>

<task type="auto">
  <name>Task 2: Add video links to MarkerPopup</name>
  <files>src/components/MarkerPopup.jsx</files>
  <action>
Display linked videos in the popup for visited locations:

1. Add `videos` to the props destructuring (optional array, default [])

2. After the description section and before the "Remind Me" button section, add a videos section:
   - Only show if `location.has_visited && videos && videos.length > 0`
   - Header: "Watch the Video" (singular) or "Watch the Videos" (plural)
   - For each video:
     - Thumbnail image (small, 80px wide)
     - Video title
     - Link to YouTube: `https://youtube.com/watch?v=${video.youtube_id}`
     - Open in new tab (target="_blank" rel="noopener noreferrer")

3. Styling:
   - Container with subtle background (bg-gray-50 or similar)
   - Rounded corners, padding
   - Videos stacked vertically with small gap
   - Thumbnail on left, title on right (flex row)
   - Play icon overlay on thumbnail (optional, nice-to-have)
   - Title truncated if too long

4. Keep the popup compact - thumbnails at 60-80px width, titles at text-sm
  </action>
  <verify>MarkerPopup displays video section when location has videos</verify>
  <done>MarkerPopup shows linked videos with thumbnails and YouTube links</done>
</task>

<task type="auto">
  <name>Task 3: Pass videos to MarkerPopup in MapPage</name>
  <files>src/pages/MapPage.jsx</files>
  <action>
Update MapPage to pass videos to MarkerPopup:

1. In the Marker/Popup section where MarkerPopup is rendered:
   - Add `videos={location.videos || []}` prop

2. No other changes needed - fetchLocations now returns videos with locations
  </action>
  <verify>MapPage passes videos prop to MarkerPopup</verify>
  <done>MapPage provides video data to popup component</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] fetchLocations includes videos in response
- [ ] MarkerPopup shows video section for visited locations with videos
- [ ] Clicking video thumbnail/title opens YouTube in new tab
- [ ] Popup remains compact and usable on mobile
- [ ] Locations without videos display normally (no empty section)
- [ ] npm run build succeeds
</verification>

<success_criteria>

- Visited locations with linked videos show them in popup
- Video links work and open YouTube
- Unvisited locations and locations without videos unaffected
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-video-location-ux/10-02-SUMMARY.md`
</output>
