---
phase: 13-user-map-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useMapFilters.js
  - src/components/SidebarFilters.jsx
autonomous: true
---

<objective>
Add search and country filter functionality to the public map for all users.

Purpose: Enable users to find specific locations by name or filter by country, improving discoverability for 600+ pins.
Output: Search input and country dropdown in sidebar, filtering applied to map markers.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/hooks/useMapFilters.js
@src/components/SidebarFilters.jsx
@src/pages/MapPage.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend useMapFilters hook with search and country filtering</name>
  <files>src/hooks/useMapFilters.js</files>
  <action>
Add search and country filtering to the existing useMapFilters hook:

1. Add new state variables:
   ```js
   const [searchQuery, setSearchQuery] = useState('');
   const [countryFilter, setCountryFilter] = useState('');
   ```

2. Compute unique countries from validLocations (follow admin pattern):
   ```js
   const uniqueCountries = useMemo(() => {
     return validLocations
       .filter(loc => loc.country_code != null)
       .reduce((acc, loc) => {
         if (!acc.find(c => c.code === loc.country_code)) {
           acc.push({ code: loc.country_code, name: loc.country || loc.country_code });
         }
         return acc;
       }, [])
       .sort((a, b) => a.name.localeCompare(b.name));
   }, [validLocations]);
   ```

3. Extend the filteredLocations useMemo to include search and country filters:
   - Add `matchesSearch`: case-insensitive search using toLowerCase():
     ```js
     const matchesSearch = !searchQuery ||
       loc.name.toLowerCase().includes(searchQuery.toLowerCase());
     ```
   - Add `matchesCountry`: check if location country_code matches countryFilter:
     ```js
     const matchesCountry = !countryFilter || loc.country_code === countryFilter;
     ```
   - Combine with existing status/category logic: existing filters AND matchesSearch AND matchesCountry

4. Export new state and handlers:
   - `searchQuery`, `setSearchQuery`
   - `countryFilter`, `setCountryFilter`
   - `uniqueCountries`
  </action>
  <verify>Hook file updated without syntax errors. Imports unchanged.</verify>
  <done>useMapFilters returns searchQuery, setSearchQuery, countryFilter, setCountryFilter, and uniqueCountries</done>
</task>

<task type="auto">
  <name>Task 2: Add search and country filter UI to SidebarFilters</name>
  <files>src/components/SidebarFilters.jsx</files>
  <action>
Add search input and country dropdown to the sidebar filters:

1. Accept new props:
   - `searchQuery`, `setSearchQuery`
   - `countryFilter`, `setCountryFilter`
   - `uniqueCountries`

2. Add search input at the top of the filters section (above Map Style):
   ```jsx
   <div className="mb-4">
     <label className="block text-xs text-muted mb-2 uppercase tracking-wider font-medium">
       Search
     </label>
     <input
       type="text"
       value={searchQuery}
       onChange={(e) => setSearchQuery(e.target.value)}
       placeholder="Search locations..."
       className="w-full p-2.5 rounded-md border border-white/20 bg-secondary text-gray-100 text-sm placeholder:text-gray-400"
     />
   </div>
   ```

3. Add country dropdown after search (before Map Style):
   ```jsx
   {uniqueCountries.length > 0 && (
     <div className="mb-4">
       <label className="block text-xs text-muted mb-2 uppercase tracking-wider font-medium">
         Country
       </label>
       <select
         value={countryFilter}
         onChange={(e) => setCountryFilter(e.target.value)}
         className="w-full p-2.5 rounded-md border border-white/20 bg-secondary text-gray-100 text-sm cursor-pointer"
       >
         <option value="">All Countries</option>
         {uniqueCountries.map(c => (
           <option key={c.code} value={c.code}>{c.name}</option>
         ))}
       </select>
     </div>
   )}
   ```

4. Add Search icon import from lucide-react (optional, for visual enhancement)

5. Update MapPage.jsx to pass the new props to SidebarFilters:
   - Destructure new values from useMapFilters
   - Pass searchQuery, setSearchQuery, countryFilter, setCountryFilter, uniqueCountries to SidebarFilters
  </action>
  <verify>npm run build succeeds</verify>
  <done>Search input and country dropdown appear in sidebar, filtering works when typing/selecting</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] Search input filters markers by location name
- [ ] Country dropdown filters markers by country
- [ ] Filters combine with existing status/category filters
- [ ] Empty search/country shows all (no filter applied)
</verification>

<success_criteria>

- Users can search locations by name
- Users can filter by country
- All existing filters (status, category) still work
- Filters combine correctly (AND logic)
- No performance regressions
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/13-user-map-search/13-01-SUMMARY.md`
</output>
