---
phase: 04-database-schema-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [supabase/migrations/001_core_tables.sql]
autonomous: true
---

<objective>
Create core database tables for locations, categories, videos, and their relationships.

Purpose: Establish the foundation for location-centric data storage, replacing static sampleData.js with real database tables.
Output: SQL migration file with core tables and RLS policies for public read access.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-database-schema-redesign/04-CONTEXT.md

@src/data/sampleData.js
@src/utils/supabaseClient.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Supabase migrations directory</name>
  <files>supabase/migrations/</files>
  <action>
Create the supabase directory structure for migrations:
- Create `supabase/` directory at project root
- Create `supabase/migrations/` subdirectory

This follows Supabase CLI conventions even if user runs migrations via dashboard.
  </action>
  <verify>Directory exists: `ls supabase/migrations/`</verify>
  <done>supabase/migrations/ directory exists</done>
</task>

<task type="auto">
  <name>Task 2: Create core tables migration</name>
  <files>supabase/migrations/001_core_tables.sql</files>
  <action>
Create SQL migration file with the following tables:

**1. categories table:**
```sql
- id: text PRIMARY KEY (e.g., 'nature', 'city', 'food')
- name: text NOT NULL (display name)
- icon: text (emoji)
- color_hex: text (e.g., '#4CAF50')
- color_name: text (e.g., 'green')
- created_at: timestamptz DEFAULT now()
```

**2. locations table:**
```sql
- id: uuid PRIMARY KEY DEFAULT gen_random_uuid()
- slug: text UNIQUE NOT NULL (URL-friendly identifier)
- name: text NOT NULL
- latitude: decimal NOT NULL
- longitude: decimal NOT NULL
- category_id: text REFERENCES categories(id)
- has_visited: boolean DEFAULT false
- date_visited: date (nullable)
- short_description: text
- notes: text
- created_at: timestamptz DEFAULT now()
- updated_at: timestamptz DEFAULT now()
```

**3. videos table:**
```sql
- id: uuid PRIMARY KEY DEFAULT gen_random_uuid()
- youtube_id: text UNIQUE NOT NULL (the video ID from YouTube URL)
- title: text NOT NULL
- description: text
- thumbnail_url: text
- created_at: timestamptz DEFAULT now()
```

**4. location_videos junction table:**
```sql
- id: uuid PRIMARY KEY DEFAULT gen_random_uuid()
- location_id: uuid REFERENCES locations(id) ON DELETE CASCADE
- video_id: uuid REFERENCES videos(id) ON DELETE CASCADE
- display_order: integer DEFAULT 0 (for ordering, 0-2)
- created_at: timestamptz DEFAULT now()
- UNIQUE(location_id, video_id)
```

**Constraint for max 3 videos per location:**
Create a trigger function that checks count before insert and raises exception if >= 3.

**RLS Policies:**
- Enable RLS on all tables
- Add policy for public read (SELECT) on all tables: `USING (true)`
- No insert/update/delete policies yet (admin-only via service role)

**Indexes:**
- locations(category_id)
- locations(has_visited)
- location_videos(location_id)
- location_videos(video_id)
  </action>
  <verify>File exists and contains CREATE TABLE statements: `grep -c "CREATE TABLE" supabase/migrations/001_core_tables.sql` returns 4</verify>
  <done>Migration file contains categories, locations, videos, location_videos tables with RLS policies</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] supabase/migrations/ directory exists
- [ ] 001_core_tables.sql contains all 4 tables
- [ ] RLS enabled on all tables
- [ ] Public read policies defined
- [ ] Max 3 videos constraint trigger exists
- [ ] Foreign key relationships correct
</verification>

<success_criteria>

- All tasks completed
- Migration file is valid SQL syntax
- Tables match the location-centric vision from CONTEXT.md
- Schema supports: locations with categories, videos linked to locations (max 3)
</success_criteria>

<output>
After completion, create `.planning/phases/04-database-schema-redesign/04-01-SUMMARY.md`
</output>
