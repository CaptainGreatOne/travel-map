---
phase: 04-database-schema-redesign
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [supabase/migrations/002_suggestions_and_rate_limiting.sql]
autonomous: true
---

<objective>
Create suggestions, reminders, and rate limiting infrastructure in the database.

Purpose: Enable users to suggest new locations and remind about existing ones, with database-enforced monthly limits (1 suggestion/month, 3 reminders/month).
Output: SQL migration file with suggestions system tables, counting tables, and trigger functions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-database-schema-redesign/04-CONTEXT.md

@src/utils/supabaseClient.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create suggestions and reminders tables</name>
  <files>supabase/migrations/002_suggestions_and_rate_limiting.sql</files>
  <action>
Create SQL migration file with the following tables:

**1. suggestions table (new location requests):**
```sql
- id: uuid PRIMARY KEY DEFAULT gen_random_uuid()
- user_id: uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
- location_name: text NOT NULL
- google_maps_url: text (nullable - user may not provide)
- latitude: decimal (nullable - extracted from URL if possible)
- longitude: decimal (nullable - extracted from URL if possible)
- reason: text (why they want this location)
- status: text DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected'))
- admin_notes: text (for admin to track decisions)
- created_at: timestamptz DEFAULT now()
- reviewed_at: timestamptz
```

**2. reminders table (reminders for existing locations):**
```sql
- id: uuid PRIMARY KEY DEFAULT gen_random_uuid()
- user_id: uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
- location_id: uuid NOT NULL REFERENCES locations(id) ON DELETE CASCADE
- message: text (optional message from user)
- created_at: timestamptz DEFAULT now()
- UNIQUE(user_id, location_id) -- one reminder per user per location
```

**Indexes:**
- suggestions(user_id)
- suggestions(status)
- suggestions(created_at)
- reminders(user_id)
- reminders(location_id)
  </action>
  <verify>File contains CREATE TABLE for suggestions and reminders: `grep -E "CREATE TABLE.*(suggestions|reminders)" supabase/migrations/002_suggestions_and_rate_limiting.sql | wc -l` returns 2</verify>
  <done>suggestions and reminders tables created with proper foreign keys</done>
</task>

<task type="auto">
  <name>Task 2: Create rate limiting infrastructure</name>
  <files>supabase/migrations/002_suggestions_and_rate_limiting.sql</files>
  <action>
Add to the same migration file:

**1. user_suggestion_counts table:**
```sql
- id: uuid PRIMARY KEY DEFAULT gen_random_uuid()
- user_id: uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
- year_month: text NOT NULL (format: 'YYYY-MM')
- suggestion_count: integer DEFAULT 0
- UNIQUE(user_id, year_month)
```

**2. user_reminder_counts table:**
```sql
- id: uuid PRIMARY KEY DEFAULT gen_random_uuid()
- user_id: uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
- year_month: text NOT NULL (format: 'YYYY-MM')
- reminder_count: integer DEFAULT 0
- UNIQUE(user_id, year_month)
```

**3. Function: check_suggestion_limit()**
```sql
CREATE OR REPLACE FUNCTION check_suggestion_limit()
RETURNS TRIGGER AS $$
DECLARE
  current_month text;
  current_count integer;
BEGIN
  current_month := to_char(now(), 'YYYY-MM');

  SELECT suggestion_count INTO current_count
  FROM user_suggestion_counts
  WHERE user_id = NEW.user_id AND year_month = current_month;

  IF current_count IS NOT NULL AND current_count >= 1 THEN
    RAISE EXCEPTION 'Monthly suggestion limit reached (1 per month)';
  END IF;

  -- Upsert the count
  INSERT INTO user_suggestion_counts (user_id, year_month, suggestion_count)
  VALUES (NEW.user_id, current_month, 1)
  ON CONFLICT (user_id, year_month)
  DO UPDATE SET suggestion_count = user_suggestion_counts.suggestion_count + 1;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**4. Function: check_reminder_limit()**
Similar to above but with limit of 3 per month.

**5. Triggers:**
```sql
CREATE TRIGGER enforce_suggestion_limit
  BEFORE INSERT ON suggestions
  FOR EACH ROW
  EXECUTE FUNCTION check_suggestion_limit();

CREATE TRIGGER enforce_reminder_limit
  BEFORE INSERT ON reminders
  FOR EACH ROW
  EXECUTE FUNCTION check_reminder_limit();
```

**RLS Policies:**

For suggestions:
- Enable RLS
- SELECT: Users can see their own suggestions `USING (auth.uid() = user_id)`
- INSERT: Authenticated users can insert `WITH CHECK (auth.uid() = user_id)`

For reminders:
- Enable RLS
- SELECT: Users can see their own reminders `USING (auth.uid() = user_id)`
- INSERT: Authenticated users can insert `WITH CHECK (auth.uid() = user_id)`

For counting tables:
- Enable RLS
- SELECT: Users can see their own counts `USING (auth.uid() = user_id)`
- No direct INSERT/UPDATE - managed by triggers
  </action>
  <verify>File contains trigger functions: `grep -c "CREATE.*FUNCTION" supabase/migrations/002_suggestions_and_rate_limiting.sql` returns at least 2</verify>
  <done>Rate limiting tables, functions, and triggers created with proper RLS</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] suggestions table with google_maps_url field exists
- [ ] reminders table with location_id foreign key exists
- [ ] Counting tables for both suggestions and reminders exist
- [ ] Trigger functions check limits (1 suggestion, 3 reminders per month)
- [ ] Triggers attached to INSERT on both tables
- [ ] RLS policies allow authenticated insert, own-row select
</verification>

<success_criteria>

- All tasks completed
- Migration file is valid SQL syntax
- Rate limits enforced at database level (not application)
- Clear separation between suggestions (new places) and reminders (existing places)
- Google Maps URL can be stored for suggestions
</success_criteria>

<output>
After completion, create `.planning/phases/04-database-schema-redesign/04-02-SUMMARY.md`
</output>
