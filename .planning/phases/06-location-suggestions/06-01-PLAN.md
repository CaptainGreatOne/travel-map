---
phase: 06-location-suggestions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/expand-url/index.ts
  - src/utils/parseGoogleMapsUrl.js
autonomous: true
---

<objective>
Create Supabase Edge Function to expand short Google Maps URLs.

Purpose: Short URLs (maps.app.goo.gl) cannot be expanded in-browser due to CORS. A server-side function can follow the redirect and return the full URL.
Output: Working Edge Function that expands short URLs, integrated into parseGoogleMapsUrl.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-location-suggestions/06-CONTEXT.md

@src/utils/parseGoogleMapsUrl.js
@src/components/SuggestForm.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create expand-url Edge Function</name>
  <files>supabase/functions/expand-url/index.ts</files>
  <action>
Create Supabase Edge Function at `supabase/functions/expand-url/index.ts`:

1. Create the functions directory structure: `supabase/functions/expand-url/`
2. Implement the function:
   - Accept POST request with `{ url: string }`
   - Validate URL is a Google Maps short URL (maps.app.goo.gl or goo.gl/maps)
   - Use fetch with `redirect: 'manual'` to get redirect location header
   - Return `{ expandedUrl: string }` on success
   - Return appropriate error responses for invalid URLs or fetch failures
   - Add CORS headers for browser access

Edge Function structure:
```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

serve(async (req) => {
  // Handle CORS preflight
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  // ... implementation
})
```

The function should handle the redirect chain (short URL → intermediate → final full URL).
  </action>
  <verify>
Function file exists at supabase/functions/expand-url/index.ts with proper structure.
Test locally with: `supabase functions serve expand-url --no-verify-jwt` if supabase CLI available.
  </verify>
  <done>Edge Function created with CORS headers, URL validation, and redirect following.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Edge Function into parseGoogleMapsUrl</name>
  <files>src/utils/parseGoogleMapsUrl.js</files>
  <action>
Update `parseGoogleMapsUrlAsync` in src/utils/parseGoogleMapsUrl.js:

1. Add helper function to get Edge Function URL:
   - Use `import.meta.env.VITE_SUPABASE_URL` to construct function URL
   - Format: `{SUPABASE_URL}/functions/v1/expand-url`

2. When `isShortGoogleMapsUrl(url)` is true:
   - Call the Edge Function with the short URL
   - If successful, parse the returned expanded URL
   - If Edge Function fails/unavailable, fall back to current behavior (isShortUrl: true flag)

3. Update return type to include `expanded: boolean` to indicate if URL was expanded

4. Handle errors gracefully:
   - Network errors → fall back to isShortUrl hint
   - Invalid response → fall back to isShortUrl hint
   - Timeout (5 seconds) → fall back to isShortUrl hint

Keep existing URL parsing patterns unchanged - this only affects short URL handling.
  </action>
  <verify>
- `npm run build` succeeds
- Short URL detection still works (isShortGoogleMapsUrl)
- Full URLs still parse correctly without calling Edge Function
  </verify>
  <done>parseGoogleMapsUrlAsync calls Edge Function for short URLs, with graceful fallback.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Edge Function file exists with proper TypeScript/Deno structure
- [ ] parseGoogleMapsUrl.js updated with Edge Function integration
- [ ] `npm run build` succeeds without errors
- [ ] Existing full URL parsing still works (no regression)
</verification>

<success_criteria>
- Edge Function created in supabase/functions/expand-url/
- parseGoogleMapsUrlAsync attempts to expand short URLs via Edge Function
- Graceful fallback when Edge Function unavailable
- No regressions in existing URL parsing
</success_criteria>

<output>
After completion, create `.planning/phases/06-location-suggestions/06-01-SUMMARY.md`
</output>
