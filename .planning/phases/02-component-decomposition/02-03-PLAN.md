---
phase: 02-component-decomposition
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [src/pages/MapPage.jsx]
autonomous: true
---

<objective>
Refactor MapPage to use the extracted hook, component, and utilities.

Purpose: Reduce MapPage from 354 lines to under 150 by using extracted pieces.
Output: Simplified MapPage that imports from new modules.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/02-component-decomposition/02-01-SUMMARY.md

@src/pages/MapPage.jsx
@src/hooks/useMapFilters.js
@src/components/MarkerPopup.jsx
@src/utils/mapStyles.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor MapPage to use extracted modules</name>
  <files>src/pages/MapPage.jsx</files>
  <action>
    Rewrite MapPage to import and use the extracted pieces:

    1. Import new modules:
       ```js
       import { useMapFilters } from '../hooks/useMapFilters';
       import MarkerPopup from '../components/MarkerPopup';
       import { mapStyles, createColoredIcon } from '../utils/mapStyles';
       ```

    2. Replace inline filter state/logic with hook:
       ```js
       const {
         selectedStatuses, selectedCategories, mapStyle, colorScheme, filtersOpen,
         categoriesWithCounts, filteredLocations, visitedCount, wantToVisitCount,
         handleToggleStatus, handleToggleCategory, setMapStyle, setColorScheme, setFiltersOpen
       } = useMapFilters(locations, categoryData);
       ```

    3. Replace popup content with MarkerPopup component:
       ```jsx
       <Popup closeOnClick={false} onClose={...}>
         <MarkerPopup
           location={location}
           categoryInfo={getCategoryInfo(location.category)}
           isShowingForm={showingSuggestionForm === location.id}
           isSuccess={suggestionSuccess === location.id}
           user={user}
           onShowForm={() => setShowingSuggestionForm(location.id)}
           onCancelForm={() => setShowingSuggestionForm(null)}
           onSuccess={() => {
             setShowingSuggestionForm(null);
             setSuggestionSuccess(location.id);
             setTimeout(() => setSuggestionSuccess(null), 5000);
           }}
         />
       </Popup>
       ```

    4. Remove the inline mapStyles object (now imported)

    5. Remove the createColoredIcon function (now imported)

    6. Keep: Leaflet icon fix (lines 14-20), suggestion form state, getCategoryInfo helper

    7. REMOVE debug console.log statements (lines 37-39)
  </action>
  <verify>npm run dev - MapPage renders with all functionality working</verify>
  <done>MapPage refactored to under 150 lines, all features working</done>
</task>

<task type="auto">
  <name>Task 2: Verify MapPage line count</name>
  <files>src/pages/MapPage.jsx</files>
  <action>
    Count lines in refactored MapPage.

    Target: Under 150 lines.

    If over 150 lines, identify what else can be extracted:
    - getCategoryInfo could move to useMapFilters hook
    - getMarkerIcon could move to mapStyles.js
    - sidebarFilters JSX could become a component

    Make additional extractions if needed to hit target.
  </action>
  <verify>wc -l src/pages/MapPage.jsx shows under 150</verify>
  <done>MapPage is under 150 lines</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run dev works without errors
- [ ] Map page displays correctly
- [ ] Filters work (status, category, map style)
- [ ] Marker popups show correct content
- [ ] Suggestion form works in popup
- [ ] MapPage.jsx is under 150 lines
- [ ] No console.log debug statements remain
</verification>

<success_criteria>
- MapPage refactored to use extracted modules
- Line count under 150
- All functionality preserved
- Debug logging removed
</success_criteria>

<output>
After completion, create `.planning/phases/02-component-decomposition/02-03-SUMMARY.md`
</output>
