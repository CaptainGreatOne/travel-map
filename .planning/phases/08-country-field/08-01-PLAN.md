---
phase: 08-country-field
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [supabase/migrations/006_add_country_to_locations.sql, src/utils/parseGoogleMapsUrl.js, src/utils/parseGoogleMapsUrl.test.js]
autonomous: true
---

<objective>
Add country field infrastructure: database column and URL parser extraction.

Purpose: Enable country tracking for locations by adding the database column and extending the Google Maps URL parser to extract country information.
Output: Migration file for country_code column, updated parseGoogleMapsUrl with country extraction.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-country-field/08-CONTEXT.md

@supabase/migrations/001_core_tables.sql
@src/utils/parseGoogleMapsUrl.js
@src/utils/parseGoogleMapsUrl.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration for country_code column</name>
  <files>supabase/migrations/006_add_country_to_locations.sql</files>
  <action>
Create migration to add country_code column to locations table:
- Add country_code text column (nullable, 2-character ISO code like 'US', 'JP', 'GB')
- Add index on country_code for efficient filtering
- Follow existing migration naming pattern (006_...)

Column should be:
- nullable (existing locations won't have country)
- text type for flexibility (some codes may need more than 2 chars for edge cases)
- indexed for admin filtering performance
  </action>
  <verify>cat supabase/migrations/006_add_country_to_locations.sql shows valid SQL with ALTER TABLE, ADD COLUMN, CREATE INDEX</verify>
  <done>Migration file exists with country_code column addition and index creation</done>
</task>

<task type="auto">
  <name>Task 2: Extend parseGoogleMapsUrl to extract country</name>
  <files>src/utils/parseGoogleMapsUrl.js</files>
  <action>
Add parseGoogleMapsCountry function to extract country from Google Maps URLs.

Google Maps URLs contain country info in different places:
1. The place name often ends with country (e.g., "Eiffel Tower, Paris, France")
2. The URL path sometimes contains country code
3. The full address in the place string

Implementation approach:
- Create parseGoogleMapsCountry(url) function
- Extract from place name by looking for last comma-separated segment
- Common patterns: "Location, City, Country" or "Location, Country"
- Return { country: string, countryCode: string } or null

Also update parseGoogleMapsUrlAsync to include country in the result:
- Add country and countryCode fields to ParseResult typedef
- Call parseGoogleMapsCountry and include in result object

Country code mapping:
- If extracted country is full name, try to map to ISO code
- Use a simple lookup object for common countries (USA→US, Japan→JP, United Kingdom→GB, etc.)
- If no match, use null for countryCode but still return country name

DO NOT use external geocoding APIs - extract from URL text only.
  </action>
  <verify>Node can import the module: node -e "import('./src/utils/parseGoogleMapsUrl.js').then(m => console.log(typeof m.parseGoogleMapsCountry))"</verify>
  <done>parseGoogleMapsCountry function exists, parseGoogleMapsUrlAsync includes country/countryCode in result</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for country extraction</name>
  <files>src/utils/parseGoogleMapsUrl.test.js</files>
  <action>
Add test cases for parseGoogleMapsCountry function:

Test cases to cover:
1. URL with "Location, City, Country" pattern → extracts country
2. URL with "Location, Country" pattern → extracts country
3. Common countries map to ISO codes (France→FR, Japan→JP, United States→US)
4. URL without country info → returns null
5. parseGoogleMapsUrlAsync includes country in result

Use existing test file structure and Vitest patterns.
  </action>
  <verify>npm test -- --run src/utils/parseGoogleMapsUrl.test.js passes with new tests</verify>
  <done>Tests pass for country extraction covering main URL patterns</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration file exists at supabase/migrations/006_add_country_to_locations.sql
- [ ] parseGoogleMapsCountry function exported from parseGoogleMapsUrl.js
- [ ] parseGoogleMapsUrlAsync returns country and countryCode fields
- [ ] npm test passes for parseGoogleMapsUrl tests
</verification>

<success_criteria>
- All tasks completed
- Migration ready to apply (adds country_code column with index)
- URL parser extracts country from place names
- Tests verify extraction logic
</success_criteria>

<output>
After completion, create `.planning/phases/08-country-field/08-01-SUMMARY.md`
</output>
