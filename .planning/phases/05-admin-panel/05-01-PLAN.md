---
phase: 05-admin-panel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/components/AdminGuard.jsx, src/services/adminService.js, .env.example]
autonomous: true
---

<objective>
Create the foundation for admin panel: authentication guard and service layer.

Purpose: Establish secure admin access control and data operations before building UI.
Output: AdminGuard component for route protection, adminService for CRUD operations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/contexts/AuthContext.jsx
@src/services/locationService.js
@src/services/suggestionService.js
@src/utils/supabaseClient.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AdminGuard component</name>
  <files>src/components/AdminGuard.jsx, .env.example</files>
  <action>
Create `src/components/AdminGuard.jsx` that protects admin routes:

1. Read admin emails from env var `VITE_ADMIN_EMAILS` (comma-separated list)
2. Use `useAuth()` to get current user
3. Check if user is logged in AND user.email is in admin list
4. If not admin: show "Access Denied" message with option to go back
5. If admin: render children

```jsx
// Pattern:
const adminEmails = (import.meta.env.VITE_ADMIN_EMAILS || '').split(',').map(e => e.trim().toLowerCase());
const isAdmin = user && adminEmails.includes(user.email?.toLowerCase());
```

Also update `.env.example` to document the new env var:
```
VITE_ADMIN_EMAILS=admin@example.com
```

Style the "Access Denied" view with Tailwind - centered message, link to home page.
  </action>
  <verify>File exists and exports AdminGuard component: `grep -l "export default AdminGuard" src/components/AdminGuard.jsx`</verify>
  <done>AdminGuard component created with email whitelist logic</done>
</task>

<task type="auto">
  <name>Task 2: Create adminService for CRUD operations</name>
  <files>src/services/adminService.js</files>
  <action>
Create `src/services/adminService.js` with admin-only database operations.

**Note:** These operations require Supabase service role or appropriate RLS policies. For now, implement the functions - we'll add admin write policies in the migration.

**Location operations:**
```js
// Create location
export async function createLocation(data) {
  // data: { slug, name, latitude, longitude, category_id, has_visited, date_visited, short_description, notes }
  const { data: location, error } = await supabase
    .from('locations')
    .insert(data)
    .select()
    .single();
  // Return { success, data, error }
}

// Update location
export async function updateLocation(id, data) { ... }

// Delete location
export async function deleteLocation(id) { ... }
```

**Video operations:**
```js
// Create video
export async function createVideo(data) {
  // data: { youtube_id, title, description, thumbnail_url }
}

// Delete video
export async function deleteVideo(id) { ... }

// Link video to location
export async function linkVideoToLocation(locationId, videoId, displayOrder = 0) { ... }

// Unlink video from location
export async function unlinkVideoFromLocation(locationId, videoId) { ... }
```

**Suggestion operations:**
```js
// Get all suggestions (with user email for display)
export async function fetchSuggestions(status = null) {
  // If status provided, filter by it
  // Join with auth.users to get email (or store email in suggestions table)
}

// Update suggestion status
export async function updateSuggestionStatus(id, status, adminNotes = null) {
  // status: 'approved' | 'rejected'
  // Set reviewed_at to now()
}
```

**Dashboard metrics:**
```js
export async function fetchDashboardMetrics() {
  // Return counts: total locations, pending suggestions, total reminders
  const [locationsRes, suggestionsRes, remindersRes] = await Promise.all([
    supabase.from('locations').select('id', { count: 'exact', head: true }),
    supabase.from('suggestions').select('id', { count: 'exact', head: true }).eq('status', 'pending'),
    supabase.from('reminders').select('id', { count: 'exact', head: true })
  ]);
  return {
    totalLocations: locationsRes.count || 0,
    pendingSuggestions: suggestionsRes.count || 0,
    totalReminders: remindersRes.count || 0
  };
}
```

Follow existing service patterns: return `{ success, data, error }` or `null` on error with console.error logging.
  </action>
  <verify>File exports all functions: `grep -c "export async function" src/services/adminService.js` returns at least 8</verify>
  <done>adminService created with location, video, suggestion, and metrics operations</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] AdminGuard.jsx exists and uses email whitelist from env var
- [ ] adminService.js exports CRUD functions for locations, videos, suggestions
- [ ] Both files follow existing code conventions (camelCase, default exports where appropriate)
</verification>

<success_criteria>

- All tasks completed
- AdminGuard protects routes with email whitelist
- adminService provides all CRUD operations needed for admin panel
- Code follows established patterns from locationService and suggestionService
</success_criteria>

<output>
After completion, create `.planning/phases/05-admin-panel/05-01-SUMMARY.md`
</output>
