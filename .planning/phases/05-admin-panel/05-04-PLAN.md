---
phase: 05-admin-panel
plan: 04
type: execute
wave: 3
depends_on: ["05-02"]
files_modified: [src/components/admin/SuggestionModerator.jsx, src/components/admin/VideoManager.jsx, src/pages/AdminPage.jsx]
autonomous: true
---

<objective>
Create Suggestion Moderation and Video Management UI for the admin panel.

Purpose: Allow admins to moderate user suggestions and manage videos linked to locations.
Output: SuggestionModerator and VideoManager components with full functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-admin-panel/05-02-SUMMARY.md

@src/pages/AdminPage.jsx
@src/services/adminService.js
@supabase/migrations/002_suggestions_and_rate_limiting.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SuggestionModerator component</name>
  <files>src/components/admin/SuggestionModerator.jsx</files>
  <action>
Create `src/components/admin/SuggestionModerator.jsx` with:

**1. Suggestion list display:**
- Fetch suggestions using `fetchSuggestions()` from adminService
- Filter tabs: All, Pending, Approved, Rejected
- Display as cards or table with: location_name, reason, status, created_at, google_maps_url (if provided)

**2. Moderation actions:**
- Approve button: Sets status to 'approved', updates reviewed_at
- Reject button: Sets status to 'rejected', updates reviewed_at
- Optional admin notes field (text input before action)

**3. Suggestion detail view:**
- Show full reason text
- Show Google Maps URL as clickable link (opens in new tab)
- Show coordinates if provided
- Show user info (email or ID)

**4. State management:**
- suggestions: array
- filter: 'all' | 'pending' | 'approved' | 'rejected'
- loading, error states

**5. UI patterns (Tailwind):**
```jsx
// Filter tabs
<div className="flex gap-2 mb-4">
  {['all', 'pending', 'approved', 'rejected'].map(f => (
    <button
      key={f}
      onClick={() => setFilter(f)}
      className={`px-4 py-2 rounded ${filter === f ? 'bg-primary text-white' : 'bg-gray-100'}`}
    >
      {f.charAt(0).toUpperCase() + f.slice(1)}
    </button>
  ))}
</div>

// Suggestion card
<div className="bg-white p-4 rounded-lg shadow mb-4">
  <div className="flex justify-between items-start">
    <div>
      <h3 className="font-semibold">{suggestion.location_name}</h3>
      <p className="text-gray-600 text-sm mt-1">{suggestion.reason}</p>
      {suggestion.google_maps_url && (
        <a href={suggestion.google_maps_url} target="_blank" className="text-primary text-sm">
          View on Google Maps
        </a>
      )}
    </div>
    <span className={`px-2 py-1 rounded text-xs ${statusColors[suggestion.status]}`}>
      {suggestion.status}
    </span>
  </div>
  {suggestion.status === 'pending' && (
    <div className="mt-4 flex gap-2">
      <button onClick={() => handleApprove(suggestion.id)} className="bg-green-500 text-white px-3 py-1 rounded">
        Approve
      </button>
      <button onClick={() => handleReject(suggestion.id)} className="bg-red-500 text-white px-3 py-1 rounded">
        Reject
      </button>
    </div>
  )}
</div>
```

**6. Refresh after moderation:**
- After status change, refetch or update local state
- Show feedback message
  </action>
  <verify>File exists with moderation functions: `grep -c "handleApprove\|handleReject" src/components/admin/SuggestionModerator.jsx` returns at least 2</verify>
  <done>SuggestionModerator component created with filtering and moderation actions</done>
</task>

<task type="auto">
  <name>Task 2: Create VideoManager component</name>
  <files>src/components/admin/VideoManager.jsx</files>
  <action>
Create `src/components/admin/VideoManager.jsx` with:

**1. Video list display:**
- Fetch all videos from database (add `fetchVideos()` to adminService if needed)
- Display as cards with: thumbnail, title, youtube_id, linked locations count
- "Add Video" button at top

**2. Add video form:**
- Fields: youtube_id (required), title (required), description (optional)
- Auto-fetch thumbnail URL from YouTube: `https://img.youtube.com/vi/${youtube_id}/mqdefault.jpg`
- Validate youtube_id format (11 characters, alphanumeric + dash/underscore)

**3. Link video to location:**
- Each video card has "Link to Location" button
- Opens modal with location dropdown
- Calls `linkVideoToLocation()` from adminService
- Show currently linked locations on video card

**4. Delete video:**
- Delete button with confirmation
- Calls `deleteVideo()` (cascade deletes from location_videos)

**5. State management:**
- videos: array
- locations: array (for linking dropdown)
- isFormOpen: boolean
- linkingVideo: video object being linked (or null)

**6. UI patterns (Tailwind):**
```jsx
// Video card
<div className="bg-white rounded-lg shadow overflow-hidden">
  <img
    src={`https://img.youtube.com/vi/${video.youtube_id}/mqdefault.jpg`}
    alt={video.title}
    className="w-full h-32 object-cover"
  />
  <div className="p-4">
    <h3 className="font-semibold truncate">{video.title}</h3>
    <p className="text-gray-500 text-sm">ID: {video.youtube_id}</p>
    <div className="mt-3 flex gap-2">
      <button onClick={() => setLinkingVideo(video)} className="text-primary text-sm">
        Link to Location
      </button>
      <button onClick={() => handleDelete(video.id)} className="text-red-500 text-sm">
        Delete
      </button>
    </div>
  </div>
</div>

// Grid layout
<div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
  {videos.map(video => <VideoCard key={video.id} video={video} />)}
</div>
```

**7. Add fetchVideos to adminService if not present:**
```js
export async function fetchVideos() {
  const { data, error } = await supabase
    .from('videos')
    .select('*, location_videos(location_id)')
    .order('created_at', { ascending: false });
  if (error) {
    console.error('Failed to fetch videos:', error);
    return null;
  }
  return data;
}
```
  </action>
  <verify>File exists with video operations: `grep -c "handleDelete\|linkVideoToLocation\|fetchVideos" src/components/admin/VideoManager.jsx` returns at least 2</verify>
  <done>VideoManager component created with add, link, and delete functionality</done>
</task>

<task type="auto">
  <name>Task 3: Integrate components into AdminPage</name>
  <files>src/pages/AdminPage.jsx</files>
  <action>
Update `src/pages/AdminPage.jsx` to:

1. Import both components:
   ```jsx
   import SuggestionModerator from '../components/admin/SuggestionModerator';
   import VideoManager from '../components/admin/VideoManager';
   ```

2. Replace the placeholders:
   ```jsx
   {activeTab === 'suggestions' && <SuggestionModerator />}
   {activeTab === 'videos' && <VideoManager />}
   ```

Ensure both components render within the admin page's content area.
  </action>
  <verify>AdminPage imports both components: `grep -c "SuggestionModerator\|VideoManager" src/pages/AdminPage.jsx` returns at least 2</verify>
  <done>SuggestionModerator and VideoManager integrated into AdminPage</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] SuggestionModerator displays suggestions with filter tabs
- [ ] Approve/Reject actions work and update database
- [ ] VideoManager displays videos with thumbnails
- [ ] Add video form works
- [ ] Link video to location works
- [ ] Delete video works
- [ ] Both components integrated into AdminPage
</verification>

<success_criteria>

- All tasks completed
- Admin can view and filter suggestions by status
- Admin can approve or reject pending suggestions
- Admin can add new videos with YouTube ID
- Admin can link videos to locations
- Admin can delete videos
</success_criteria>

<output>
After completion, create `.planning/phases/05-admin-panel/05-04-SUMMARY.md`
</output>
