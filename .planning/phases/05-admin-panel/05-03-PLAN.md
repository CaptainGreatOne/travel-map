---
phase: 05-admin-panel
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified: [src/components/admin/LocationManager.jsx, src/pages/AdminPage.jsx, supabase/migrations/004_admin_write_policies.sql]
autonomous: true
---

<objective>
Create Location Management UI for the admin panel.

Purpose: Allow admins to add, edit, and delete locations from the database.
Output: LocationManager component with full CRUD functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-admin-panel/05-02-SUMMARY.md

@src/pages/AdminPage.jsx
@src/services/adminService.js
@src/services/locationService.js
@supabase/migrations/001_core_tables.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin write policies migration</name>
  <files>supabase/migrations/004_admin_write_policies.sql</files>
  <action>
Create migration file that adds write policies for admin operations.

**Approach:** Use a simple admin check - for now, we'll allow any authenticated user to write (since the AdminGuard already restricts access to the admin UI). Later this can be tightened with a proper admin role.

```sql
-- Migration: 004_admin_write_policies
-- Description: Add write policies for admin operations
-- Phase: 05-admin-panel

-- ============================================================================
-- LOCATIONS WRITE POLICIES
-- ============================================================================

-- Allow authenticated users to insert locations
CREATE POLICY "locations_auth_insert" ON locations
  FOR INSERT
  WITH CHECK (auth.role() = 'authenticated');

-- Allow authenticated users to update locations
CREATE POLICY "locations_auth_update" ON locations
  FOR UPDATE
  USING (auth.role() = 'authenticated');

-- Allow authenticated users to delete locations
CREATE POLICY "locations_auth_delete" ON locations
  FOR DELETE
  USING (auth.role() = 'authenticated');

-- ============================================================================
-- VIDEOS WRITE POLICIES
-- ============================================================================

CREATE POLICY "videos_auth_insert" ON videos
  FOR INSERT
  WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "videos_auth_update" ON videos
  FOR UPDATE
  USING (auth.role() = 'authenticated');

CREATE POLICY "videos_auth_delete" ON videos
  FOR DELETE
  USING (auth.role() = 'authenticated');

-- ============================================================================
-- LOCATION_VIDEOS WRITE POLICIES
-- ============================================================================

CREATE POLICY "location_videos_auth_insert" ON location_videos
  FOR INSERT
  WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "location_videos_auth_delete" ON location_videos
  FOR DELETE
  USING (auth.role() = 'authenticated');

-- ============================================================================
-- SUGGESTIONS UPDATE POLICY (for admin moderation)
-- ============================================================================

CREATE POLICY "suggestions_auth_update" ON suggestions
  FOR UPDATE
  USING (auth.role() = 'authenticated');
```

**Note:** The real security is the AdminGuard component. These policies just enable the operations for authenticated users. In production, you could add a custom claim check for admin role.
  </action>
  <verify>File contains write policies: `grep -c "CREATE POLICY" supabase/migrations/004_admin_write_policies.sql` returns at least 8</verify>
  <done>Admin write policies migration created</done>
</task>

<task type="auto">
  <name>Task 2: Create LocationManager component</name>
  <files>src/components/admin/LocationManager.jsx</files>
  <action>
Create `src/components/admin/LocationManager.jsx` with:

**1. Location list display:**
- Fetch all locations using `fetchLocations()` from locationService
- Display as a table with columns: Name, Category, Visited, Actions
- Add "New Location" button at top

**2. Add/Edit form (modal or inline):**
- Fields: name, slug (auto-generate from name), latitude, longitude, category_id (dropdown), has_visited (checkbox), date_visited (date picker, conditional), short_description, notes
- Category dropdown populated from categories table (fetch on mount)
- Slug auto-generates from name: `name.toLowerCase().replace(/[^a-z0-9]+/g, '-')`
- Validation: name required, lat/lng required and valid numbers

**3. CRUD operations:**
- Create: Call `createLocation()` from adminService
- Edit: Populate form with existing data, call `updateLocation()`
- Delete: Confirm dialog, call `deleteLocation()`

**4. State management:**
- locations: array of locations
- categories: array for dropdown
- editingLocation: null or location object being edited
- isFormOpen: boolean for add/edit form visibility
- loading, error states

**5. UI patterns (Tailwind):**
```jsx
// Table
<table className="w-full">
  <thead className="bg-gray-50">
    <tr>
      <th className="px-4 py-2 text-left text-sm font-medium text-gray-500">Name</th>
      ...
    </tr>
  </thead>
  <tbody className="divide-y">
    {locations.map(loc => (
      <tr key={loc.id}>
        <td className="px-4 py-3">{loc.name}</td>
        ...
        <td>
          <button onClick={() => handleEdit(loc)}>Edit</button>
          <button onClick={() => handleDelete(loc.id)}>Delete</button>
        </td>
      </tr>
    ))}
  </tbody>
</table>

// Form modal
{isFormOpen && (
  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div className="bg-white rounded-lg p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto">
      <h2>{editingLocation ? 'Edit Location' : 'Add Location'}</h2>
      <form onSubmit={handleSubmit}>...</form>
    </div>
  </div>
)}
```

**6. Refresh list after CRUD:**
- After successful create/update/delete, refetch locations
- Show success/error toast or message
  </action>
  <verify>File exists with CRUD functions: `grep -c "handleDelete\|handleEdit\|handleSubmit" src/components/admin/LocationManager.jsx` returns at least 3</verify>
  <done>LocationManager component created with full CRUD functionality</done>
</task>

<task type="auto">
  <name>Task 3: Integrate LocationManager into AdminPage</name>
  <files>src/pages/AdminPage.jsx</files>
  <action>
Update `src/pages/AdminPage.jsx` to:

1. Import LocationManager:
   ```jsx
   import LocationManager from '../components/admin/LocationManager';
   ```

2. Replace the placeholder for locations tab:
   ```jsx
   {activeTab === 'locations' && <LocationManager />}
   ```

Ensure the component renders within the admin page's content area with appropriate styling.
  </action>
  <verify>AdminPage imports LocationManager: `grep -l "LocationManager" src/pages/AdminPage.jsx`</verify>
  <done>LocationManager integrated into AdminPage locations tab</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration file creates write policies for locations, videos, location_videos, suggestions
- [ ] LocationManager component displays list of locations
- [ ] Add/Edit form works with all location fields
- [ ] Delete with confirmation works
- [ ] AdminPage shows LocationManager in locations tab
</verification>

<success_criteria>

- All tasks completed
- Admin can view all locations in table format
- Admin can add new locations with all fields
- Admin can edit existing locations
- Admin can delete locations with confirmation
- Database write policies in place for authenticated users
</success_criteria>

<output>
After completion, create `.planning/phases/05-admin-panel/05-03-SUMMARY.md`
</output>
