---
phase: 12-map-performance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/pages/MapPage.jsx
autonomous: true
---

<objective>
Add marker clustering for 600+ pins and click-away-to-close popup behavior.

Purpose: Improve map performance and UX for large datasets.
Output: Clustered markers that expand on zoom, popups that close when clicking elsewhere on the map.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/pages/MapPage.jsx
@src/utils/mapStyles.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure marker clustering</name>
  <files>package.json, src/pages/MapPage.jsx</files>
  <action>
1. Install react-leaflet-cluster:
   ```
   npm install react-leaflet-cluster
   ```

2. In MapPage.jsx:
   - Import MarkerClusterGroup from 'react-leaflet-cluster'
   - Wrap the markers map() inside a MarkerClusterGroup component
   - Configure cluster options:
     - chunkedLoading: true (for performance with 600+ markers)
     - spiderfyOnMaxZoom: true (spread overlapping markers at max zoom)
     - showCoverageOnHover: false (cleaner UX)
     - maxClusterRadius: 50 (pixels - reasonable grouping distance)

3. The cluster will automatically:
   - Group nearby markers into clusters showing count
   - Expand clusters on click/zoom
   - Show individual markers when zoomed in enough

Note: react-leaflet-cluster is the standard choice for react-leaflet v4/v5 and wraps Leaflet.markercluster.
  </action>
  <verify>npm run build succeeds, markers cluster at low zoom levels</verify>
  <done>Markers cluster when zoomed out, expand when zoomed in</done>
</task>

<task type="auto">
  <name>Task 2: Add click-away-to-close popup behavior</name>
  <files>src/pages/MapPage.jsx</files>
  <action>
Add functionality to close open popups when clicking on the map (not on a marker):

1. Create a custom component inside MapPage that uses react-leaflet's useMapEvents hook:
   ```jsx
   function MapClickHandler({ onMapClick }) {
     useMapEvents({
       click: (e) => {
         // Only trigger if clicking on map, not on a marker or popup
         if (e.originalEvent.target.classList.contains('leaflet-container') ||
             e.originalEvent.target.closest('.leaflet-tile-pane')) {
           onMapClick();
         }
       }
     });
     return null;
   }
   ```

2. Add this component inside MapContainer, passing a callback that:
   - Closes the map's open popup via map.closePopup()
   - Resets suggestion form state (setShowingSuggestionForm(null))
   - Resets success state (setSuggestionSuccess(null))

3. Import useMapEvents from 'react-leaflet'

4. Change Popup's closeOnClick from false to true (or remove it, as true is default)
   - This allows Leaflet's native click-to-close behavior

Actually simpler approach:
- Just remove `closeOnClick={false}` from Popup
- Leaflet will handle click-away natively
- Still need to reset our React state on popup close (already handled via onClose callback)
  </action>
  <verify>Click on empty map area closes any open popup</verify>
  <done>Clicking away from markers closes popup, form state resets properly</done>
</task>

<task type="auto">
  <name>Task 3: Style cluster markers</name>
  <files>src/pages/MapPage.jsx</files>
  <action>
Add custom styling for cluster markers to match the app's design:

1. react-leaflet-cluster uses CSS classes for styling. Add inline styles or a style tag for:
   - .marker-cluster-small (< 10 markers)
   - .marker-cluster-medium (10-99 markers)
   - .marker-cluster-large (100+ markers)

2. Use colors that complement existing marker colors:
   - Small clusters: light blue background
   - Medium clusters: blue background
   - Large clusters: darker blue background
   - White text for count
   - Circular shape with subtle shadow

3. Can use iconCreateFunction prop on MarkerClusterGroup for fully custom cluster icons if needed.

Keep it simple - the default styling works, just ensure it doesn't clash with existing design.
  </action>
  <verify>Cluster markers have consistent styling with the app</verify>
  <done>Cluster markers styled appropriately</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm install succeeds for react-leaflet-cluster
- [ ] npm run build succeeds
- [ ] Markers cluster when map is zoomed out
- [ ] Clusters show count and expand on click
- [ ] Clicking on map (not marker) closes popup
- [ ] Popup close resets form state correctly
- [ ] Cluster styling looks appropriate
</verification>

<success_criteria>

- 600+ markers render efficiently via clustering
- Clusters expand smoothly on zoom/click
- Click-away closes popups
- No performance regressions
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/12-map-performance/12-01-SUMMARY.md`
</output>
