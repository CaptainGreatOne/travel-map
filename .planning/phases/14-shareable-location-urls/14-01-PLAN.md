---
phase: 14-shareable-location-urls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/pages/MapPage.jsx, src/components/MarkerPopup.jsx]
autonomous: true
---

<objective>
Implement shareable location URLs with two-way sync: URL updates when markers are clicked, and shared URLs open the map centered on the location with popup visible.

Purpose: Enable users to share specific locations via URL and land directly on that location's popup.
Output: Working URL-based location sharing with share button in popup.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-shareable-location-urls/14-CONTEXT.md

@src/pages/MapPage.jsx
@src/components/MarkerPopup.jsx
@src/App.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Read URL parameter and open location popup on mount</name>
  <files>src/pages/MapPage.jsx</files>
  <action>
1. Import `useSearchParams` from react-router-dom at the top of MapPage.jsx
2. Inside MapPage, call `const [searchParams, setSearchParams] = useSearchParams()` to read URL params
3. Extract location slug: `const locationSlug = searchParams.get('location')`
4. After locations load (in useEffect or separate effect), if locationSlug exists:
   - Find matching location: `locations.find(loc => loc.slug === locationSlug)`
   - If NOT found: clear the URL param with `setSearchParams({})` (silent redirect to clean map)
   - If found: store in state `const [selectedLocation, setSelectedLocation] = useState(null)`
5. Add a ref to track marker refs: `const markerRefs = useRef({})`
6. On each Marker, add ref: `ref={(ref) => { if (ref) markerRefs.current[location.id] = ref }}`
7. When selectedLocation is set and markerRefs has the marker, programmatically open popup:
   ```js
   useEffect(() => {
     if (selectedLocation && markerRefs.current[selectedLocation.id]) {
       markerRefs.current[selectedLocation.id].openPopup();
     }
   }, [selectedLocation, filteredLocations]);
   ```
8. Use MapContainer's `center` prop or `map.setView()` to center on location coords when selectedLocation exists

Note: useSearchParams must be called inside a component that's a child of BrowserRouter. MapPage is rendered inside BrowserRouter via App.jsx, so this works.
  </action>
  <verify>
1. Visit `/?location=some-valid-slug` - map centers on location, popup opens
2. Visit `/?location=nonexistent` - redirects to `/` (clean URL, no error)
3. Visit `/` - normal map behavior, no popup auto-opened
  </verify>
  <done>URL with valid location slug opens map centered on that location with popup visible. Invalid slugs silently redirect to clean map URL.</done>
</task>

<task type="auto">
  <name>Task 2: Update URL when marker is clicked</name>
  <files>src/pages/MapPage.jsx</files>
  <action>
1. On Marker click (use eventHandlers prop), update URL:
   ```jsx
   <Marker
     eventHandlers={{
       click: () => {
         setSearchParams({ location: location.slug });
       }
     }}
   >
   ```
2. When popup closes (existing onClose handler), clear the URL param:
   ```jsx
   onClose={() => {
     setShowingSuggestionForm(null);
     setSuggestionSuccess(null);
     setSearchParams({}); // Clear location from URL
     setSelectedLocation(null); // Clear selected state
   }}
   ```
3. Ensure the URL updates WITHOUT page reload (React Router handles this)

Note: setSearchParams replaces current params. Use `{ location: slug }` to set, `{}` to clear.
  </action>
  <verify>
1. Click a marker - URL updates to `/?location=slug-name`
2. Close popup - URL returns to `/`
3. Copy URL from address bar while popup is open, paste in new tab - opens same location
  </verify>
  <done>Browser URL reflects currently open popup. Clicking marker updates URL, closing popup clears it.</done>
</task>

<task type="auto">
  <name>Task 3: Add share icon to popup with copy-to-clipboard</name>
  <files>src/components/MarkerPopup.jsx</files>
  <action>
1. Import Share2 or Link icon from lucide-react: `import { Link2 } from 'lucide-react'`
2. Add a new prop to MarkerPopup: `onShare` callback
3. Add share icon button in the popup header area (next to location name):
   ```jsx
   <div className="flex items-center justify-between mb-2">
     <h3 className="m-0 text-lg text-secondary font-semibold">
       {location.name}
     </h3>
     <button
       onClick={onShare}
       className="p-1.5 text-gray-400 hover:text-primary hover:bg-gray-100 rounded transition-colors"
       title="Copy link to location"
       aria-label="Share location"
     >
       <Link2 size={16} />
     </button>
   </div>
   ```
4. In MapPage.jsx, pass onShare prop to MarkerPopup:
   ```jsx
   onShare={() => {
     const url = `${window.location.origin}/?location=${location.slug}`;
     navigator.clipboard.writeText(url).then(() => {
       // Optional: show brief "Copied!" feedback
     });
   }}
   ```
5. Add brief visual feedback when copied - could be a tooltip or brief text change. Keep it simple:
   - Option A: Change icon color briefly (use state)
   - Option B: Show small "Copied!" text that fades

Keep the icon small and unobtrusive per user preference for minimal UI impact.
  </action>
  <verify>
1. Open any marker popup - share icon visible in header
2. Click share icon - URL copied to clipboard
3. Paste copied URL - contains `?location=slug`
4. Visual feedback appears briefly after copy
  </verify>
  <done>Share icon in popup header copies shareable URL to clipboard with visual feedback.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] Visit `/?location=valid-slug` - centers and opens popup
- [ ] Visit `/?location=invalid` - redirects to clean `/`
- [ ] Click marker - URL updates
- [ ] Close popup - URL clears
- [ ] Share icon copies correct URL
- [ ] Pasted URL works in new tab
</verification>

<success_criteria>
- All tasks completed
- URL syncs bidirectionally with popup state
- Share button provides one-click copy
- Invalid slugs fail gracefully (silent redirect)
- No UI clutter in popup
</success_criteria>

<output>
After completion, create `.planning/phases/14-shareable-location-urls/14-01-SUMMARY.md`
</output>
